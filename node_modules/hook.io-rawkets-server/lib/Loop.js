/**************************************************
** GAME LOOP MANAGER
**************************************************/

// Much of this is based on logic from WPilot

var util = require("util");

var Loop = exports.Loop = function (options) {
	var self = this;

	self.tick = options.tick || 0; // Number of "ticks" (complete game loops) since the game started
	self.run = false; // Loop only runs when this is true
	self.currentTime = Date.now(); // Current game time in milliseconds
};

Loop.prototype.start = function() {
	var self = this;

	self.run = true;

	var loop = function() {
		var newTime = Date.now(), // New time
			timeDelta = (newTime - self.currentTime) / 1000; // Time delta in seconds

		self.currentTime = newTime;

		// Check for onTick method as it can be nullified
		if (self.onTick) {
			self.onTick(self.tick, self.currentTime, timeDelta);
		}

		self.tick++;

		if (self.run === true) {
			setTimeout(function() {
				loop();
			}, 1000/60);
		}
	};

	// Start the first loop
	loop();
};

Loop.prototype.stop = function() {
	var self = this;

	self.run = false;
};

// Called on tick completion (to be overridden)
Loop.prototype.onTick = function(tick, currentTime, timeDelta) {};